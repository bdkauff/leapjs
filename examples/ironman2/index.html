<html>
  <head>
    <title>Iron Man 2 - Leap</title>
    <style>
      body{margin: 0px; padding: 0px;}
      canvas { width: 100%; height: 100%; background-color: black; background-image: url('media/bg.jpg');}
    </style>
    <script src="scripts/three.js"></script>
    <script src="scripts/leap.js"></script>
  </head>
  <body>
    <script>
      //create scene
      var scene = new THREE.Scene();
      var renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement); 


      // create a Directional light as pretend sunshine.
      directional = new THREE.DirectionalLight( 0xCCCCCC, 1.2 )
      directional.castShadow = true
      directional.position.set( 100, 200, 300 )
      directional.target.position.copy( new THREE.Vector3(0,0,0) )
      directional.shadowCameraTop     =  1000
      directional.shadowCameraRight   =  1000
      directional.shadowCameraBottom  = -1000
      directional.shadowCameraLeft    = -1000
      directional.shadowCameraNear    =  600
      directional.shadowCameraFar     = -600
      directional.shadowBias          =   -0.0001
      directional.shadowDarkness      =    0.4
      directional.shadowMapWidth      = directional.shadowMapHeight = 2048
      scene.add( directional )

      window.ambient = new THREE.AmbientLight( 0x666666 )
      scene.add( ambient )



      //add camera
      WIDTH      = window.innerWidth,
      HEIGHT     = window.innerHeight,
      VIEW_ANGLE = 45,
      ASPECT     = WIDTH / HEIGHT,
      NEAR       = 0.1,
      FAR        = 10000
      window.camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR );
      camera.lookAt( scene.position )
      camera.position.set( 0, 0, 290 )


      //earth object
      earthObject = new THREE.Object3D()

      //earth wireframe
      window.earthWireframe = new THREE.Mesh(
        new THREE.SphereGeometry( 40+1, 32, 32 ),
        new THREE.MeshBasicMaterial({ 
          color: 0xabd7e5,
          wireframe: true,
          transparent: true,
          opacity: .1
        })
      )
      earthWireframe.position.set( 0, 0, 0 )
      earthObject.add( earthWireframe )

      //add earth object to scene
      scene.add(earthObject)

      //earth continents
      window.earthCont = new THREE.Mesh(
        new THREE.SphereGeometry( 40, 32, 32 ),
        new THREE.MeshBasicMaterial({ 
          color: 0xacd3e3,
          transparent: true,
          map: THREE.ImageUtils.loadTexture('media/earthCont2.png')
        })
      )
      earthCont.position.set( 0, 0, 0 )
      earthObject.add( earthCont )

      //earth continents
      window.torus1 = new THREE.Mesh(
        new THREE.TorusGeometry( 43, 1, 30, 30 ),
        new THREE.MeshBasicMaterial({ 
          color: 0x4073a2,
          transparent: true,
          opacity: .8
        })
      )
      torus1.position.set( 0, 0, 0 )
      earthObject.add( torus1 )

      //earth continents
      window.torus2 = new THREE.Mesh(
        new THREE.TorusGeometry( 43, 1, 30, 30 ),
        new THREE.MeshBasicMaterial({ 
          color: 0x4073a2,
          transparent: true,
          opacity: .8
        })
      )
      torus2.rotation.y = 1.57
      torus2.position.set( 0, 0, 0 )
      earthObject.add( torus2 )

      //add earth object to scene
      scene.add(earthObject)



      //particle system
      var fingerPosX = 0;
      var fingerPosY = 0;
      var fingerPosZ = 0;
      attributes = []
      numParticles = 250

      sprite = THREE.ImageUtils.loadTexture('media/particle.png')
      material =  new THREE.ParticleBasicMaterial( {
                color: 0xFFFFFF,
                size: 20, 
                map: sprite,
                transparent: true,
                // opacity: .1,
                // blending: THREE.AdditiveBlending
               } )


      geometry = new THREE.Geometry()
      for(var i=0; i < numParticles; i++){
        position = new THREE.Vector3( 0, 0, 0 )
        velocity = new THREE.Vector3( Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5 )
        force = new THREE.Vector3( 0, 0, 0 )
        geometry.vertices.push( position )
        var thisAttr = { vel: {x: 0, y: Math.random(), z: 0}, lifespan: Math.random() * 2000, acc: Math.random()*2-1 }
        attributes.push(thisAttr)
      }


      function updateParticle(){
        for(var i = 0; i< numParticles; i++){
          v = attributes[i].vel
          p = particleSys.geometry.vertices[i]
          attributes[i].lifespan -= 5
          if( isDead(i) ){
            p.x = fingerPosX + Math.random()*5
            p.y = fingerPosY + Math.random()*5
            p.z = fingerPosZ
            attributes[i].lifespan = 100
          }
        }
      }

      function isDead(thisone){
        if(attributes[thisone].lifespan <= 0.0){
          return true
        }else{
          return false
        }
      }


      particleSys = new THREE.ParticleSystem( geometry, material )
      particleSys.sortParticles = true
      scene.add(particleSys)






      //left palm
      window.leftPalm = new THREE.Mesh(
        new THREE.SphereGeometry( 10, 32, 32 ),
        new THREE.MeshLambertMaterial({ 
          color: 0x0000FF
        })
      )
      leftPalm.position.set( 0, 0, 0 )
      scene.add( leftPalm )


      //right palm
      window.rightPalm = new THREE.Mesh(
        new THREE.SphereGeometry( 10, 32, 32 ),
        new THREE.MeshLambertMaterial({ 
          color: 0xFF0000
        })
      )
      rightPalm.position.set( 0, 0, 0 )
      scene.add( rightPalm )


      var angleZ = 0;
      var angleY = 0;
      var length = 0;
      var center = 0;

      //request animation frame and connect to leap socket
      Leap.loop(function(frame) {

        if(frame.hands != undefined){

          //if user is pointing with single fingure
          if(frame.pointables.length > 0){
            console.log(frame.pointables[0].tipPosition)
              updateParticle()
              fingerPosX = frame.pointables[0].tipPosition[0]
              fingerPosY = frame.pointables[0].tipPosition[1]-200
              fingerPosZ = frame.pointables[0].tipPosition[2]
          }

          //if there are 2 hands in the frame
          if(frame.hands.length == 2){
            //loop through the two hands
            for (var handId = 0; handId < frame.hands.length; handId++){
              var hand = frame.hands[handId];

              //confirm left hand - if not act as right hand
              if(handId == 0){
                if(frame.hands[0].palmPosition[0] < frame.hands[1].palmPosition[0]){
                  leftPalm.position.x = hand.palmPosition[0]
                  leftPalm.position.y = hand.palmPosition[1]-200
                  leftPalm.position.z = hand.palmPosition[2]
                }else{
                  rightPalm.position.x = hand.palmPosition[0]
                  rightPalm.position.y = hand.palmPosition[1]-200
                  rightPalm.position.z = hand.palmPosition[2]
                }
              }
              //confirm as right hand - if not act as left hand
              if(handId == 1){
                if(frame.hands[1].palmPosition[0] > frame.hands[0].palmPosition[0]){
                  rightPalm.position.x = hand.palmPosition[0]
                  rightPalm.position.y = hand.palmPosition[1]-200
                  rightPalm.position.z = hand.palmPosition[2]
                }else{
                  leftPalm.position.x = hand.palmPosition[0]
                  leftPalm.position.y = hand.palmPosition[1]-200
                  leftPalm.position.z = hand.palmPosition[2]
                }
              }
            }

            //set 2 hand variable calculations
            length = Math.abs(frame.hands[1].palmPosition[0] - frame.hands[0].palmPosition[0])
            angleZ = frame.hands[1].palmPosition[1] - frame.hands[0].palmPosition[1]
            angleY = frame.hands[1].palmPosition[2] - frame.hands[0].palmPosition[2]
            center = new THREE.Vector3( (frame.hands[1].palmPosition[0]+frame.hands[0].palmPosition[0])/2, (frame.hands[1].palmPosition[1]+frame.hands[0].palmPosition[1])/2 - 200, (frame.hands[1].palmPosition[2]+frame.hands[0].palmPosition[2])/2  )

            console.log( "length: " + Math.round(length) + ", angleZ: "+ Math.round(angleZ) + ", angleY: " + Math.round(angleY) + ", center: " + center )

            earthObject.scale.x = earthObject.scale.y = earthObject.scale.z = length/200
            earthObject.rotation.z = -angleZ/100
            earthObject.rotation.y = angleY/100
            earthObject.position = center;

          }

            torus1.rotation.y += .004
            torus2.rotation.y += .004
            earthCont.rotation.y += .002
            earthWireframe.rotation.y += .002
        }




        camera.updateProjectionMatrix();
        camera.lookAt(scene.position)
        renderer.render(scene, camera)
      });

      //window resize method
      window.addEventListener( 'resize', onWindowResize, false );
      function onWindowResize(){
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();

          renderer.setSize( window.innerWidth, window.innerHeight );
      }
    </script>
  </body>
</html>

