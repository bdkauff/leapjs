<html>
  <head>
    <title>Iron Man 2 - Leap</title>
    <style>
      body{margin: 0px; padding: 0px;}
      canvas { width: 100%; height: 100%; background-color: black; background-image: url('media/bg.jpg');}
    </style>
    <script src="scripts/three.js"></script>
    <script src="scripts/leap.js"></script>
  </head>
  <body>
    <script>
      //create scene
      var scene = new THREE.Scene();
      var renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement); 


      // create a Directional light as pretend sunshine.
      directional = new THREE.DirectionalLight( 0xCCCCCC, 1.2 )
      directional.castShadow = true
      directional.position.set( 100, 200, 300 )
      directional.target.position.copy( new THREE.Vector3(0,0,0) )
      directional.shadowCameraTop     =  1000
      directional.shadowCameraRight   =  1000
      directional.shadowCameraBottom  = -1000
      directional.shadowCameraLeft    = -1000
      directional.shadowCameraNear    =  600
      directional.shadowCameraFar     = -600
      directional.shadowBias          =   -0.0001
      directional.shadowDarkness      =    0.4
      directional.shadowMapWidth      = directional.shadowMapHeight = 2048
      scene.add( directional )

      window.ambient = new THREE.AmbientLight( 0x666666 )
      scene.add( ambient )



      //add camera
      WIDTH      = window.innerWidth,
      HEIGHT     = window.innerHeight,
      VIEW_ANGLE = 45,
      ASPECT     = WIDTH / HEIGHT,
      NEAR       = 0.1,
      FAR        = 10000
      window.camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR );
      camera.lookAt( scene.position )
      camera.position.set( 0, 0, 290 )


      //earth object
      earthObject = new THREE.Object3D()

      //earth wireframe
      window.earthWireframe = new THREE.Mesh(
        new THREE.SphereGeometry( 40+1, 32, 32 ),
        new THREE.MeshBasicMaterial({ 
          color: 0xabd7e5,
          wireframe: true,
          transparent: true,
          opacity: .1
        })
      )
      earthWireframe.position.set( 0, 0, 0 )
      earthObject.add( earthWireframe )

      //add earth object to scene
      scene.add(earthObject)

      //earth continents
      window.earthCont = new THREE.Mesh(
        new THREE.SphereGeometry( 40, 32, 32 ),
        new THREE.MeshPhongMaterial({ 
          color: 0xacd3e3,
          transparent: true,
          // specular: 0xacd3e3,
          ambient: 0xe4e6b0,
          // shininess: 2,
          // refractionRatio: 0,
          // reflectivity: 2,
          map: THREE.ImageUtils.loadTexture('media/earthCont2.png')
        })
      )
      earthCont.position.set( 0, 0, 0 )
      earthObject.add( earthCont )

      //earth continents
      window.torus1 = new THREE.Mesh(
        new THREE.TorusGeometry( 43, 1, 30, 30 ),
        new THREE.MeshBasicMaterial({ 
          color: 0x4073a2,
          transparent: true,
          opacity: .8
        })
      )
      torus1.position.set( 0, 0, 0 )
      earthObject.add( torus1 )

      //earth continents
      window.torus2 = new THREE.Mesh(
        new THREE.TorusGeometry( 43, 1, 30, 30 ),
        new THREE.MeshBasicMaterial({ 
          color: 0x4073a2,
          transparent: true,
          opacity: .8
        })
      )
      torus2.rotation.y = 1.57
      torus2.position.set( 0, 0, 0 )
      earthObject.add( torus2 )

      //add earth object to scene
      scene.add(earthObject)



      //pointer
      window.point = new THREE.Mesh(
        new THREE.SphereGeometry( 5, 16, 16 ),
        new THREE.MeshBasicMaterial({ 
          color: 0x4073a2
        })
      )
      point.position.set( 0, 0, 0 )
      scene.add( point )


      //left palm
      window.leftPalm = new THREE.Mesh(
        new THREE.SphereGeometry( 10, 32, 32 ),
        new THREE.MeshLambertMaterial({ 
          color: 0x0000FF
        })
      )
      leftPalm.position.set( 0, 0, 0 )
      scene.add( leftPalm )


      //right palm
      window.rightPalm = new THREE.Mesh(
        new THREE.SphereGeometry( 10, 32, 32 ),
        new THREE.MeshLambertMaterial({ 
          color: 0xFF0000
        })
      )
      rightPalm.position.set( 0, 0, 0 )
      scene.add( rightPalm )


      var angleZ = 0;
      var angleY = 0;
      var length = 0;
      var center = 0;
      var shrink = false;
      var grow = false;
      var scaledUp = false;
      var targetScaleUp = 2;
      var targetScaleDown = 1;
      var leftHand;
      var rightHand;
      var swipeLeft = false, swipeRight = false;

      //request animation frame and connect to leap socket
      Leap.loop(function(frame) {

        if(frame.hands != undefined){

          //if user is pointing with single fingure
          if(frame.pointables.length > 0){
            if(frame.pointables[0].tipPosition[2] < -100){
              point.position.x = frame.pointables[0].tipPosition[0]*2
              point.position.y = frame.pointables[0].tipPosition[1]-200
              point.position.z = frame.pointables[0].tipPosition[2]+200
              point.visible = true
            }else{
              point.visible = false
            }
          }


          //if there is 1 hand in the frame
          //do swipe motions
          if(frame.hands.length == 1){
            var hand = frame.hands[0];
            // console.log(hand.palmPosition[0])

            //swipe left
            //if hand is in left half of screen and is moving fast in left direction
            if(hand.palmPosition[0] < -50 && hand.palmVelocity[0] < -500){
              console.log("swipe left")
              swipeLeft = true;
            }

            //swipe right
            if(hand.palmPosition[0] > 0 && hand.palmVelocity[0] > 50){
              console.log("swipe right")
              swipeRight = true;
            }
          }



          //if there are 2 hands in the frame
          if(frame.hands.length == 2){
            //loop through the two hands
            for (var handId = 0; handId < frame.hands.length; handId++){
              var hand = frame.hands[handId];

              //confirm left hand - if not act as right hand
              if(handId == 0){
                if(frame.hands[0].palmPosition[0] < frame.hands[1].palmPosition[0]){
                  leftPalm.position.x = hand.palmPosition[0]
                  leftPalm.position.y = hand.palmPosition[1]-200
                  leftPalm.position.z = hand.palmPosition[2]
                  leftHand = hand;
                }else{
                  rightPalm.position.x = hand.palmPosition[0]
                  rightPalm.position.y = hand.palmPosition[1]-200
                  rightPalm.position.z = hand.palmPosition[2]
                  rightHand = hand;
                }
              }
              //confirm as right hand - if not act as left hand
              if(handId == 1){
                if(frame.hands[1].palmPosition[0] > frame.hands[0].palmPosition[0]){
                  rightPalm.position.x = hand.palmPosition[0]
                  rightPalm.position.y = hand.palmPosition[1]-200
                  rightPalm.position.z = hand.palmPosition[2]
                  rightHand = hand;
                }else{
                  leftPalm.position.x = hand.palmPosition[0]
                  leftPalm.position.y = hand.palmPosition[1]-200
                  leftPalm.position.z = hand.palmPosition[2]
                  leftHand = hand;
                }
              }
            }

            
            if(rightHand.palmVelocity[0] > 300 && !shrink  && length > 250) grow = true
            if(rightHand.palmVelocity[0] < -100 && !grow && length < 170) shrink = true


            //set 2 hand variable calculations
            length = Math.abs(rightHand.palmPosition[0] - leftHand.palmPosition[0])
            angleZ = rightHand.palmPosition[1] - leftHand.palmPosition[1]
            angleY = leftHand.palmPosition[2] - rightHand.palmPosition[2]
            center = new THREE.Vector3( (frame.hands[1].palmPosition[0]+frame.hands[0].palmPosition[0])/2, (frame.hands[1].palmPosition[1]+frame.hands[0].palmPosition[1])/2 - 200, (frame.hands[1].palmPosition[2]+frame.hands[0].palmPosition[2])/2  )

            //console.log(rightHand.palmVelocity[0])

            if(scaledUp){
              earthObject.rotation.z = angleZ/100
              earthObject.rotation.y = angleY/100
            }


            //console.log( "length: " + Math.round(length) + ", angleZ: "+ Math.round(angleZ) + ", angleY: " + Math.round(angleY) + ", center: " + center )

           // earthObject.scale.x = earthObject.scale.y = earthObject.scale.z = length/200
            //earthObject.rotation.z = -angleZ/100
            //earthObject.rotation.y = angleY/100
            //earthObject.position = center;

          }

            //scale up
            if(grow){
              if(earthObject.scale.x < targetScaleUp-.2){
                  earthObject.scale.x = earthObject.scale.y = earthObject.scale.z += .08
                  earthObject.position.z += 4
                  scaledUp = true;
                }
              else{
                grow = false
              }
            }

            //scale up
            if(shrink){
              if(earthObject.scale.x > targetScaleDown+.2){
                  earthObject.scale.x = earthObject.scale.y = earthObject.scale.z -= .08
                  earthObject.position.z -= 4
                  scaledUp = false;
                }
              else{
                shrink = false
              }
            }

            // console.log("s : " + shrink + ", g : " + grow)

            torus1.rotation.y += .009
            torus2.rotation.y += .009
            earthCont.rotation.y += .002
            earthWireframe.rotation.y += .002
        }




        camera.updateProjectionMatrix();
        camera.lookAt(scene.position)
        renderer.render(scene, camera)
      });

      //window resize method
      window.addEventListener( 'resize', onWindowResize, false );
      function onWindowResize(){
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();

          renderer.setSize( window.innerWidth, window.innerHeight );
      }
    </script>
  </body>
</html>

